name: Update Latest Blog Posts
on:
  schedule:
    - cron: "0 8 * * 1"    # Every Monday 08:00 UTC
  workflow_dispatch:        # Manual trigger button

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set feed URL
        run: |
          echo "FEED_URL=https://cybernetgen.com/api/rss" >> $GITHUB_ENV

      - name: Update README from RSS (robust parser)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Parse feed and inject posts
        run: |
          python - <<'PY'
          import os, re, sys
          import feedparser

          # Try primary + a few sensible fallbacks
          candidates = [
              os.environ.get("FEED_URL", "https://cybernetgen.com/api/rss"),
              "https://cybernetgen.com/blog/rss.xml",
              "https://cybernetgen.com/rss.xml",
              "https://cybernetgen.com/feed",
              "https://cybernetgen.com/feed.xml",
          ]

          entries = []
          chosen = None
          for url in candidates:
              d = feedparser.parse(url)
              if d.entries:
                  entries = d.entries[:5]
                  chosen = url
                  break

          if not entries:
              print("::error::Could not parse any entries from known feed URLs.")
              sys.exit(1)

          # Build markdown list
          lines = []
          for e in entries:
              title = (e.get("title") or "(untitled)").strip()
              link = (e.get("link") or e.get("id") or "").strip()
              if not link:
                  continue
              lines.append(f"- [{title}]({link})")
          posts_md = "\n".join(lines)

          # Replace between markers
          path = "README.md"
          src = open(path, "r", encoding="utf-8").read()
          new = re.sub(
              r"(<!-- POSTS:START -->)(.|\n)*?(<!-- POSTS:END -->)",
              r"\\1\n" + posts_md + r"\n\\3",
              src,
              flags=re.S,
          )
          if new == src:
              print("No changes to README.md")
          else:
              open(path, "w", encoding="utf-8").write(new)
              print(f"Updated README.md using feed: {chosen}")
          PY
        shell: bash

      - name: Commit and push changes
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git diff --quiet || (git add README.md && git commit -m "chore: update latest blog posts" && git push)
